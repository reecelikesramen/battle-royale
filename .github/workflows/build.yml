name: Build Rust Libraries

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-rust:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact-name: rust-macos-arm64
            library-name: librust.dylib
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            artifact-name: rust-linux-x86_64
            library-name: librust.so
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact-name: rust-windows-x86_64
            library-name: rust.dll
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
      
    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
      
    - name: Cache Cargo target directory
      uses: actions/cache@v4
      with:
        path: rust/target
        key: ${{ runner.os }}-${{ matrix.os }}-${{ matrix.target }}-cargo-target-${{ runner.os == 'Linux' && 'v4-' || '' }}${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.os }}-${{ matrix.target }}-cargo-target-${{ runner.os == 'Linux' && 'v4-' || '' }}
      
    - name: Cache protobuf (Linux)
      if: matrix.os == 'ubuntu-22.04'
      uses: actions/cache@v4
      with:
        path: |
          ~/protobuf-install/lib/libprotobuf.a
          ~/protobuf-install/lib/libprotoc.a
          ~/protobuf-install/lib/cmake/protobuf
          ~/protobuf-install/lib/pkgconfig/protobuf.pc
          ~/protobuf-install/include/google/protobuf
          ~/protobuf-install/bin/protoc
        key: linux-protobuf-21.12-cmake-config-v2
        restore-keys: |
          linux-protobuf-21.12-cmake-config-
    
    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang \
          pkg-config \
          libssl-dev \
          libabsl-dev \
          cmake \
          build-essential \
          autoconf \
          libtool \
          wget
        
        # Check if protobuf is already installed in /usr/local
        if [ ! -f /usr/local/bin/protoc ]; then
          # Check if we have a cached build in ~/protobuf-install
          if [ -f ~/protobuf-install/bin/protoc ]; then
            echo "Found cached protobuf, installing to /usr/local..."
            sudo cp -r ~/protobuf-install/* /usr/local/
            sudo ldconfig
          else
            echo "Building protobuf 21.12 from source with CMake config..."
            cd /tmp
            wget -q https://github.com/protocolbuffers/protobuf/releases/download/v21.12/protobuf-all-21.12.tar.gz
            tar -xzf protobuf-all-21.12.tar.gz
            cd protobuf-21.12
            
            mkdir build && cd build
            cmake ../cmake \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -Dprotobuf_BUILD_TESTS=OFF \
              -Dprotobuf_BUILD_SHARED_LIBS=OFF \
              -DCMAKE_INSTALL_PREFIX=~/protobuf-install \
              -Dprotobuf_ABSL_PROVIDER=package
            
            make -j$(nproc)
            make install
            
            echo "Installing cached build to /usr/local..."
            sudo cp -r ~/protobuf-install/* /usr/local/
            sudo ldconfig
            
            echo "Protobuf installed to /usr/local"
            ls -la /usr/local/lib/cmake/protobuf/ || true
          fi
        else
          echo "Using existing protobuf installation in /usr/local"
          sudo ldconfig
        fi

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install openssl protobuf@21 pkg-config
        brew unlink protobuf@21 && brew link --force protobuf@21
        # protobuf@21 is keg-only, need to set paths explicitly
        # export PROTOBUF_PREFIX=$(brew --prefix protobuf@21)
        # export OPENSSL_PREFIX=$(brew --prefix openssl@3)
        # echo "PKG_CONFIG_PATH=$OPENSSL_PREFIX/lib/pkgconfig:$PROTOBUF_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
        # echo "LDFLAGS=-L$OPENSSL_PREFIX/lib -L$PROTOBUF_PREFIX/lib" >> $GITHUB_ENV
        # echo "CPPFLAGS=-I$OPENSSL_PREFIX/include -I$PROTOBUF_PREFIX/include" >> $GITHUB_ENV
        # echo "CMAKE_PREFIX_PATH=$PROTOBUF_PREFIX:$CMAKE_PREFIX_PATH" >> $GITHUB_ENV
    
    - name: Enable long paths (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        git config --global core.longpaths true
        # Enable long path support (requires admin, will fail gracefully if not available)
        reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f 2>$null
        # Create shorter vcpkg directories
        New-Item -ItemType Directory -Force -Path "C:\vcpkg" -ErrorAction SilentlyContinue | Out-Null
        New-Item -ItemType Directory -Force -Path "C:\vcpkg-buildtrees" -ErrorAction SilentlyContinue | Out-Null
    
    - name: Build Rust release
      working-directory: rust
      env:
        GNS_VCPKG_BUILDTREES_ROOT: ${{ runner.os == 'Windows' && 'C:\\vcpkg-buildtrees' || '' }}
        GNS_VCPKG_ROOT: ${{ runner.os == 'Windows' && 'C:\\vcpkg' || '' }}
        CMAKE_PREFIX_PATH: ${{ runner.os == 'Linux' && '/usr/local;/usr;/usr/lib/x86_64-linux-gnu' || '' }}
      run: |
        cargo build --release --target ${{ matrix.target }}
      
    - name: Upload Rust library
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          rust/target/${{ matrix.target }}/release/${{ matrix.library-name }}
        retention-days: 7

