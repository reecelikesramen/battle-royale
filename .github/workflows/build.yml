name: Build Rust Libraries

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-rust:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact-name: rust-macos-arm64
            library-name: librust.dylib
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact-name: rust-linux-x86_64
            library-name: librust.so
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact-name: rust-windows-x86_64
            library-name: rust.dll
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
      
    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
      
    - name: Cache Cargo target directory
      uses: actions/cache@v4
      with:
        path: rust/target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-target-${{ runner.os == 'Linux' && 'v2-' || '' }}${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.target }}-cargo-target-${{ runner.os == 'Linux' && 'v2-' || '' }}
      
    # - name: Cache protobuf (Linux)
    #   if: matrix.os == 'ubuntu-latest'
    #   uses: actions/cache@v4
    #   with:
    #     path: |
    #       /usr/local/lib/libprotobuf.a
    #       /usr/local/lib/pkgconfig/protobuf.pc
    #       /usr/local/include/google/protobuf
    #     key: linux-protobuf-21.12-static-fpic
    #     restore-keys: |
    #       linux-protobuf-
    
    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Remove old cached protobuf from /usr/local that conflicts with system packages
        sudo rm -rf /usr/local/lib/libprotobuf* /usr/local/include/google/protobuf /usr/local/share/cmake-*/Modules/FindProtobuf.cmake || true
        
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler libprotobuf-dev pkg-config libssl-dev

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install openssl protobuf@21 pkg-config
        brew unlink protobuf@21 && brew link --force protobuf@21
        # protobuf@21 is keg-only, need to set paths explicitly
        # export PROTOBUF_PREFIX=$(brew --prefix protobuf@21)
        # export OPENSSL_PREFIX=$(brew --prefix openssl@3)
        # echo "PKG_CONFIG_PATH=$OPENSSL_PREFIX/lib/pkgconfig:$PROTOBUF_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
        # echo "LDFLAGS=-L$OPENSSL_PREFIX/lib -L$PROTOBUF_PREFIX/lib" >> $GITHUB_ENV
        # echo "CPPFLAGS=-I$OPENSSL_PREFIX/include -I$PROTOBUF_PREFIX/include" >> $GITHUB_ENV
        # echo "CMAKE_PREFIX_PATH=$PROTOBUF_PREFIX:$CMAKE_PREFIX_PATH" >> $GITHUB_ENV
    
    - name: Enable long paths (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        git config --global core.longpaths true
        # Enable long path support (requires admin, will fail gracefully if not available)
        reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f 2>$null
        # Create shorter vcpkg directories
        New-Item -ItemType Directory -Force -Path "C:\vcpkg" -ErrorAction SilentlyContinue | Out-Null
        New-Item -ItemType Directory -Force -Path "C:\vcpkg-buildtrees" -ErrorAction SilentlyContinue | Out-Null
    
    - name: Build Rust release
      working-directory: rust
      env:
        GNS_VCPKG_BUILDTREES_ROOT: ${{ runner.os == 'Windows' && 'C:\\vcpkg-buildtrees' || '' }}
        GNS_VCPKG_ROOT: ${{ runner.os == 'Windows' && 'C:\\vcpkg' || '' }}
        CMAKE_PREFIX_PATH: ${{ runner.os == 'Linux' && '/usr;/usr/lib/x86_64-linux-gnu' || '' }}
        Protobuf_DIR:       ${{ runner.os == 'Linux' && '/usr/lib/x86_64-linux-gnu/cmake/protobuf' || '' }}
        PROTOBUF_PROTOC_EXECUTABLE: ${{ runner.os == 'Linux' && '/usr/bin/protoc' || '' }}
      run: |
        cargo build --release --target ${{ matrix.target }}
      
    - name: Upload Rust library
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          rust/target/${{ matrix.target }}/release/${{ matrix.library-name }}
        retention-days: 7

